{
  "created_at": "2026-02-24T22:18:42.580239Z",
  "epic": {
    "data": {
      "branch_name": "fn-1-add-linear-bot-integration",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-24T22:15:36.699642Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [],
      "id": "fn-1-add-linear-bot-integration",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-1-add-linear-bot-integration.md",
      "status": "open",
      "title": "Add Linear bot integration",
      "updated_at": "2026-02-24T22:16:18.216704Z"
    },
    "spec": "# Add Linear Bot Integration\n\n## Overview\n\nAdd a Linear bot integration that allows users to @mention the Terragon bot in Linear issue comments to automatically spin up a sandbox. When mentioned, the bot fetches the issue context including attachments, creates a Terragon thread, starts the agent in a sandbox, and posts an acknowledgment comment back to Linear with a link to the task.\n\nThis mirrors the existing Slack @mention integration flow but adapted for Linear's webhook and API model.\n\n## Scope\n\n**In scope (v1):**\n- Webhook endpoint receiving Linear Comment.create events with HMAC-SHA256 signature verification\n- User account linking (Linear user \u2192 Terragon user) via settings UI\n- Issue + attachment fetching via @linear/sdk\n- Smart GitHub repo detection from Linear issue attachments\n- Thread creation with `\"linear-mention\"` source type\n- Acknowledgment comment posted back to Linear\n- Feature-flagged behind `linearIntegration`\n- Documentation (integration guide, env vars, release notes)\n\n**Out of scope (v2):**\n- Linear OAuth flow (v1 uses manual account linking + single API key)\n- Completion callback to Linear when thread finishes\n- Follow-up routing (second mention on same issue \u2192 queue to existing thread)\n- Automation trigger type `\"linear_mention\"`\n- Bidirectional status sync\n\n## Architecture\n\n```mermaid\nsequenceDiagram\n    participant L as Linear\n    participant W as Webhook Route\n    participant H as Handler\n    participant API as Linear API\n    participant DB as Database\n    participant T as Thread System\n\n    L->>W: POST /api/webhooks/linear (Comment.create)\n    W->>W: Verify HMAC-SHA256 signature\n    W-->>L: 200 OK (immediate)\n    W->>H: waitUntil(handleCommentCreated)\n    H->>H: Check actor.id \u2260 bot (prevent self-loop)\n    H->>H: Detect @mention in comment body\n    H->>DB: Resolve linearUserId \u2192 Terragon user\n    H->>DB: Get linearSettings (default repo, model)\n    H->>API: Fetch issue details + attachments\n    H->>H: Extract GitHub repo from attachments (if any)\n    H->>H: Build message with issue context\n    H->>T: newThreadInternal() \u2192 sandbox spin-up\n    H->>API: Post ack comment with task link\n```\n\n```mermaid\nerDiagram\n    user ||--o{ linear_account : has\n    user ||--o{ linear_settings : has\n    linear_account {\n        text id PK\n        text user_id FK\n        text linear_user_id UK\n        text linear_user_name\n        text linear_user_email\n        text organization_id\n    }\n    linear_settings {\n        text id PK\n        text user_id FK\n        text organization_id\n        text default_repo_full_name\n        text default_model\n    }\n```\n\n## Key Design Decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Auth model | Single API key (env var) | Linear has no bot concept; simplest for v1 |\n| User linking | Manual in settings | No OAuth complexity; mirrors early Slack setup |\n| Self-loop prevention | Check `actor.id` against bot user ID | Prevents infinite webhook cycles |\n| User resolution | Commenter's linearUserId | Same pattern as Slack |\n| Billing gating | Check access tier | Match GitHub pattern, prevent abuse |\n| Repo detection | GitHub attachment URL \u2192 fallback to settings default | Auto-detects without config when issue has linked PR |\n| Idempotency | Accept rare duplicates | Matches existing Slack/GitHub handler behavior |\n| DB tables | 2 (account + settings) | No org-level installation table needed with single API key |\n\n## Risks\n\n- **Linear API key is personal, not app-level**: Ack comments appear as the key owner, not a bot. Mitigate with clear docs.\n- **No interactive buttons in Linear comments**: Unlike Slack, can't add \"Try Again\" buttons for setup errors. Must use plain text with links.\n- **Webhook payload types unreliable**: SDK generated types don't match webhook payloads (flat IDs vs nested objects). Must handle defensively.\n\n## Quick commands\n\n```bash\n# Push schema changes\npnpm -C packages/shared drizzle-kit-push-dev\n\n# Type check\npnpm tsc-check\n\n# Run tests\npnpm -C apps/www test\npnpm -C packages/shared test\n\n# Test webhook locally (via ngrok)\ncurl -X POST http://localhost:3000/api/webhooks/linear \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Linear-Signature: <computed-sig>\" \\\n  -d '{\"action\":\"create\",\"type\":\"Comment\",\"data\":{\"body\":\"@Terragon fix the auth bug\",\"issueId\":\"...\"}}'\n```\n\n## Acceptance\n\n- [ ] Linear Comment.create webhooks verified and processed\n- [ ] Bot @mention detected in comment body, non-mentions ignored\n- [ ] Self-triggering loop prevented (bot's own comments skipped)\n- [ ] Linear user resolved to Terragon user via linked account\n- [ ] Issue details + attachments fetched and included in thread message\n- [ ] GitHub repo auto-detected from Linear attachments when available\n- [ ] Thread created via `newThreadInternal()` with correct sourceType/sourceMetadata\n- [ ] Acknowledgment comment posted back to Linear with task link\n- [ ] Settings UI allows linking Linear account and configuring defaults\n- [ ] Feature-flagged behind `linearIntegration`\n- [ ] Documentation updated (integration guide, env vars, release notes)\n- [ ] All type checks pass (`pnpm tsc-check`)\n\n## References\n\n- Slack webhook route: `apps/www/src/app/api/webhooks/slack/route.ts`\n- Slack handler: `apps/www/src/app/api/webhooks/slack/handlers.ts`\n- Slack model: `packages/shared/src/model/slack.ts`\n- Slack DB tables: `packages/shared/src/db/schema.ts:633-717`\n- Thread source types: `packages/shared/src/db/types.ts:79-113`\n- Thread creation: `apps/www/src/server-lib/new-thread-internal.ts:13-61`\n- Linear SDK webhooks: `@linear/sdk/webhooks` (LinearWebhookClient)\n- Linear GraphQL schema: `github.com/linear/linear/packages/sdk/src/schema.graphql`\n"
  },
  "epic_id": "fn-1-add-linear-bot-integration",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-24T22:16:23.444982Z",
        "depends_on": [],
        "epic": "fn-1-add-linear-bot-integration",
        "id": "fn-1-add-linear-bot-integration.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-1-add-linear-bot-integration.1.md",
        "status": "todo",
        "title": "Schema, types, env vars, feature flag, and model layer",
        "updated_at": "2026-02-24T22:17:03.698577Z"
      },
      "id": "fn-1-add-linear-bot-integration.1",
      "runtime": null,
      "spec": "# fn-1-add-linear-bot-integration.1 Schema, types, env vars, feature flag, and model layer\n\n## Description\nAdd the foundation layer for Linear integration: DB schema (2 new tables), type system updates, environment variables, feature flag, npm dependency, and the model CRUD layer with tests.\n\n**Size:** M\n**Files:**\n- `packages/shared/src/db/schema.ts` \u2014 add `linearAccount` and `linearSettings` tables\n- `packages/shared/src/db/types.ts` \u2014 add `\"linear-mention\"` to ThreadSource, new ThreadSourceMetadata variant, type exports\n- `packages/env/src/apps-www.ts` \u2014 add LINEAR_WEBHOOK_SECRET, LINEAR_API_KEY, LINEAR_BOT_DISPLAY_NAME\n- `packages/shared/src/model/feature-flags-definitions.ts` \u2014 add `linearIntegration` flag\n- `packages/shared/src/model/linear.ts` \u2014 new model layer (CRUD for account + settings)\n- `packages/shared/src/model/linear.test.ts` \u2014 model layer tests\n- `apps/www/package.json` \u2014 add `@linear/sdk` dependency\n\n## Approach\n\n- Follow `slackAccount` + `slackSettings` table patterns at `schema.ts:661-717`\n- Follow `packages/shared/src/model/slack.ts` for CRUD functions (same structure: get, upsert, delete)\n- Include `publishBroadcastUserMessage()` calls after mutations (same as Slack model)\n- DB tables need 2 unique indexes each (user+org and linearUserId+org) matching Slack's pattern\n- `linearAccount` does NOT need encrypted tokens for v1 (using global API key, not per-user OAuth)\n- After schema changes, push with `pnpm -C packages/shared drizzle-kit-push-dev`\n- Run `pnpm -C apps/www add @linear/sdk` for the Linear SDK\n\n## Key context\n\n- `ThreadSourceMetadata` is a discriminated union at `types.ts:91-113` \u2014 add a new `type: \"linear-mention\"` variant with: `organizationId`, `issueId`, `issueIdentifier`, `commentId`, `issueUrl`\n- Feature flag pattern: `{ defaultValue: false, description: \"...\" }` \u2014 see existing flags at `feature-flags-definitions.ts:27-133`\n- Env var pattern: `str({ allowEmpty: true, default: \"\" })` \u2014 see Slack section at `apps-www.ts:97-100`\n## Acceptance\n- [ ] `linearAccount` table created with columns: id, userId, linearUserId, linearUserName, linearUserEmail, organizationId, createdAt, updatedAt\n- [ ] `linearSettings` table created with columns: id, userId, organizationId, defaultRepoFullName, defaultModel, createdAt, updatedAt\n- [ ] Both tables have proper FK references to user.id with cascade delete\n- [ ] `\"linear-mention\"` added to ThreadSource union type\n- [ ] `linear-mention` variant added to ThreadSourceMetadata discriminated union\n- [ ] LinearAccount, LinearAccountInsert, LinearSettings, LinearSettingsInsert types exported\n- [ ] 3 env vars defined: LINEAR_WEBHOOK_SECRET, LINEAR_API_KEY, LINEAR_BOT_DISPLAY_NAME\n- [ ] `linearIntegration` feature flag defined with defaultValue: false\n- [ ] Model functions: getLinearAccountForLinearUserId, getLinearAccounts, upsertLinearAccount, deleteLinearAccount, getLinearSettingsForOrg, upsertLinearSettings\n- [ ] Model tests pass: `pnpm -C packages/shared test`\n- [ ] `@linear/sdk` added to apps/www dependencies\n- [ ] Type check passes: `pnpm tsc-check`\n- [ ] Schema pushed: `pnpm -C packages/shared drizzle-kit-push-dev`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-24T22:16:28.345731Z",
        "depends_on": ["fn-1-add-linear-bot-integration.1"],
        "epic": "fn-1-add-linear-bot-integration",
        "id": "fn-1-add-linear-bot-integration.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-1-add-linear-bot-integration.2.md",
        "status": "todo",
        "title": "Webhook route and mention handler",
        "updated_at": "2026-02-24T22:17:34.629019Z"
      },
      "id": "fn-1-add-linear-bot-integration.2",
      "runtime": null,
      "spec": "# fn-1-add-linear-bot-integration.2 Webhook route and mention handler\n\n## Description\nCreate the webhook endpoint and mention handler for Linear Comment.create events. This is the core integration logic: receive webhook \u2192 verify signature \u2192 detect @mention \u2192 resolve user \u2192 fetch issue + attachments \u2192 build message \u2192 create thread \u2192 post acknowledgment.\n\n**Size:** M\n**Files:**\n- `apps/www/src/app/api/webhooks/linear/route.ts` \u2014 new webhook route\n- `apps/www/src/app/api/webhooks/linear/handlers.ts` \u2014 new mention handler\n- `apps/www/src/app/api/webhooks/linear/handlers.test.ts` \u2014 handler tests\n\n## Approach\n\n- **Route**: Follow `apps/www/src/app/api/webhooks/slack/route.ts` pattern\n  - Use `LinearWebhookClient` from `@linear/sdk/webhooks` for signature verification (NOT manual HMAC)\n  - Return 200 immediately, process via `waitUntil()` from `@vercel/functions`\n  - Dispatch on `type === \"Comment\"` and `action === \"create\"`\n\n- **Handler**: Follow `apps/www/src/app/api/webhooks/slack/handlers.ts:390-538` pattern\n  - **Self-loop prevention**: Check webhook payload `actor.id` against a known bot user ID (derive from LINEAR_API_KEY via `linearClient.viewer` query on startup, or compare against stored ID). Skip processing if actor is the bot.\n  - **Mention detection**: Regex for `@{LINEAR_BOT_DISPLAY_NAME}` in `data.body`\n  - **User resolution**: `getLinearAccountForLinearUserId()` with `data.userId` + `organizationId`\n  - **Access tier check**: Use `getAccessInfoForUser()` to verify billing (match GitHub handler at `handle-app-mention.ts:95`)\n  - **Issue fetch**: `linearClient.issue(data.issueId)` then `issue.attachments()` for full context\n  - **GitHub repo extraction**: Parse GitHub attachment URLs (`sourceType === \"github\"`) to auto-detect repo\n  - **Message building**: Include issue identifier, title, description, comment body, attachment list, issue URL. Reuse `formatThreadContext()` from `ext-thread-context.ts`\n  - **Thread creation**: `newThreadInternal()` with sourceType `\"linear-mention\"`\n  - **Ack comment**: `linearClient.createComment({ issueId, body })` with task link\n  - **Error comments**: If no linked account or no default repo, post setup instructions to Linear (plain text with link to settings, no interactive buttons)\n\n## Key context\n\n- Practice-scout warns: SDK generated types don't match webhook payloads (flat ID strings vs nested objects). Handle `data.issueId` as string, not `data.issue.id`\n- Linear retries webhooks at 1min, 1hr, 6hr. v1 accepts rare duplicates (matching existing handlers)\n- Comment webhook `data` includes: `id`, `body`, `createdAt`, `issueId`, `issue` (child), `userId`, `user` (child), `botActor`, `parentId`\n- Rate limit: 5000 req/hr. Set `first: 20` limit on attachment queries\n- Must return 200 within 5 seconds (Linear timeout)\n## Acceptance\n- [ ] Webhook route at `POST /api/webhooks/linear` accepts and verifies Linear webhook signatures\n- [ ] Invalid signatures return 401 (or 200 with error log if LINEAR_WEBHOOK_SECRET unset in dev)\n- [ ] Non-Comment or non-create events are ignored with 200 response\n- [ ] Bot's own comments are detected and skipped (self-loop prevention)\n- [ ] @mention detected in comment body via LINEAR_BOT_DISPLAY_NAME\n- [ ] Non-mention comments are ignored\n- [ ] Linear user resolved to Terragon user via linearAccount table\n- [ ] Missing account \u2192 error comment posted to Linear with setup link\n- [ ] Missing default repo (and no GitHub attachment) \u2192 error comment posted to Linear\n- [ ] User access tier checked before thread creation\n- [ ] Issue details fetched: identifier, title, description, url, branchName\n- [ ] Issue attachments fetched and formatted in message (title, url, sourceType)\n- [ ] GitHub repo auto-extracted from attachment URL when sourceType is \"github\"\n- [ ] Thread created via `newThreadInternal()` with sourceType \"linear-mention\" and correct metadata\n- [ ] Acknowledgment comment posted to Linear with task link\n- [ ] Handler tests pass: `pnpm -C apps/www test`\n- [ ] Entire flow completes within waitUntil() (non-blocking to webhook response)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-24T22:16:33.698280Z",
        "depends_on": ["fn-1-add-linear-bot-integration.1"],
        "epic": "fn-1-add-linear-bot-integration",
        "id": "fn-1-add-linear-bot-integration.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-1-add-linear-bot-integration.3.md",
        "status": "todo",
        "title": "Settings UI for Linear account linking",
        "updated_at": "2026-02-24T22:17:51.937645Z"
      },
      "id": "fn-1-add-linear-bot-integration.3",
      "runtime": null,
      "spec": "# fn-1-add-linear-bot-integration.3 Settings UI for Linear account linking\n\n## Description\nAdd a \"Linear\" section to the integrations settings page, gated behind the `linearIntegration` feature flag. Users can link their Linear account, configure a default repository and model, and disconnect.\n\n**Size:** M\n**Files:**\n- `apps/www/src/app/(sidebar)/(site-header)/settings/integrations/page.tsx` \u2014 add Linear data fetching\n- `apps/www/src/components/settings/tab/integrations.tsx` \u2014 add Linear section\n- `apps/www/src/components/settings/linear/` \u2014 new directory for Linear-specific components\n- `apps/www/src/server-actions/linear.ts` \u2014 server actions for CRUD operations\n\n## Approach\n\n- Follow the Slack integration UI pattern at `apps/www/src/components/settings/tab/integrations.tsx`\n- Gate entire section behind `useFeatureFlag(\"linearIntegration\")`\n- Use existing `SettingsSection` component wrapper\n- **Account linking form**: Input fields for Linear organization ID and user ID. Auto-detect user info via `linearClient.viewer` query when user provides a personal API key (optional shortcut)\n- **Default repo selector**: Reuse the existing repo picker component used in Slack settings\n- **Default model selector**: Reuse existing model selector component\n- **Disconnect button**: Calls `deleteLinearAccount()` server action\n- Server actions call model layer functions from `packages/shared/src/model/linear.ts`\n\n## Key context\n\n- Settings integrations page is a server component that fetches data: `page.tsx:1-15`\n- Client component renders sections: `integrations.tsx:1-48`\n- Slack settings pattern shows how to combine account linking + config in one section\n- Must use `publishBroadcastUserMessage()` to notify client of changes (already in model layer from task 1)\n- Linear has no workspace-level \"installation\" flow \u2014 simpler than Slack (no OAuth redirect needed for v1)\n## Acceptance\n- [ ] \"Linear\" section visible in Settings > Integrations when `linearIntegration` flag is enabled\n- [ ] Section hidden when flag is disabled\n- [ ] User can enter Linear organization ID, user ID, display name, and email to link account\n- [ ] Linked account info displayed after connecting\n- [ ] Default repository configurable via repo picker\n- [ ] Default model configurable via model selector\n- [ ] Disconnect button removes linearAccount and linearSettings records\n- [ ] UI updates reactively after connect/disconnect (via broadcast message)\n- [ ] Type check passes: `pnpm tsc-check`\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-24T22:16:38.866072Z",
        "depends_on": [
          "fn-1-add-linear-bot-integration.2",
          "fn-1-add-linear-bot-integration.3"
        ],
        "epic": "fn-1-add-linear-bot-integration",
        "id": "fn-1-add-linear-bot-integration.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-1-add-linear-bot-integration.4.md",
        "status": "todo",
        "title": "Documentation and release notes",
        "updated_at": "2026-02-24T22:18:08.176555Z"
      },
      "id": "fn-1-add-linear-bot-integration.4",
      "runtime": null,
      "spec": "# fn-1-add-linear-bot-integration.4 Documentation and release notes\n\n## Description\nUpdate documentation across the project for the new Linear integration: env example, AGENTS.md, new integration guide, sidebar navigation, release notes, and early-access features list.\n\n**Size:** S\n**Files:**\n- `apps/www/.env.example` \u2014 add LINEAR_WEBHOOK_SECRET, LINEAR_API_KEY, LINEAR_BOT_DISPLAY_NAME\n- `AGENTS.md` \u2014 add Linear to Database Schema and Recent Features sections\n- `apps/docs/content/docs/integrations/linear-integration.mdx` \u2014 new integration guide\n- `apps/docs/content/docs/meta.json` \u2014 add Linear to sidebar navigation\n- `apps/docs/content/docs/resources/release-notes.mdx` \u2014 add release notes entry\n- `apps/docs/content/docs/resources/early-access-features.mdx` \u2014 add Linear to early-access list\n- `apps/www/src/lib/constants.ts` \u2014 bump RELEASE_NOTES_VERSION\n\n## Approach\n\n- `.env.example`: Follow pattern of `GITHUB_WEBHOOK_SECRET=***` with inline comments\n- `AGENTS.md`: Add to \"Database Schema\" section and \"Recent Features\" section (bottom of file)\n- Integration guide: Mirror `apps/docs/content/docs/integrations/slack-integration.mdx` structure exactly \u2014 same frontmatter, `Steps`/`Step` fumadocs components, `Callout` pointing to settings URL\n- Release notes: Follow template at `apps/docs/RELEASE_NOTES_TEMPLATE.md`. Use early-access format since feature-flagged\n- Bump `RELEASE_NOTES_VERSION` by 1 (per AGENTS.md instructions)\n\n## Key context\n\n- Slack integration doc is the structural template: `apps/docs/content/docs/integrations/slack-integration.mdx`\n- Release notes template: `apps/docs/RELEASE_NOTES_TEMPLATE.md`\n- Constants file with RELEASE_NOTES_VERSION: `apps/www/src/lib/constants.ts`\n## Acceptance\n- [ ] `.env.example` contains LINEAR_WEBHOOK_SECRET, LINEAR_API_KEY, LINEAR_BOT_DISPLAY_NAME with comments\n- [ ] `AGENTS.md` lists Linear tables in Database Schema section\n- [ ] `AGENTS.md` lists Linear integration in Recent Features section\n- [ ] `linear-integration.mdx` created with setup steps, configuration, and usage guide\n- [ ] `meta.json` includes linear-integration in sidebar navigation under integrations\n- [ ] Release notes entry added with early-access format\n- [ ] Early-access features list includes Linear integration\n- [ ] `RELEASE_NOTES_VERSION` bumped by 1\n- [ ] Docs build successfully (no broken links or frontmatter errors)\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
